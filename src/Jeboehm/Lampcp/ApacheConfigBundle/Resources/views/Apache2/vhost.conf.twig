##
#
# Generated by
#
# LampCP
# https://github.com/jeboehm/LampCP
#
# Licensed under the GPL Version 2 license
# http://www.gnu.org/licenses/gpl-2.0.txt
#
# PLEASE DO NOT CHANGE MANUALLY
# CHANGES WILL BE OVERWRITTEN
#
##

{% import "JeboehmLampcpApacheConfigBundle:Apache2:vhost.macro.twig" as macros %}

{% for ip in ips %}
{% if ip.ip != "*" and ip.domain|length > 0 %}
{% if ip.ipv6 %}
NameVirtualHost [{{ ip.ip }}]:{{ ip.port }}
{% else %}
NameVirtualHost {{ ip.ip }}:{{ ip.port }}
{% endif %}
{% endif %}
{% endfor %}

{% for vhost in vhosts %}
<VirtualHost {{ vhost.VhostAddress }}>
    ServerAdmin none@example.com
    ServerName {{ vhost.ServerName }}
    DocumentRoot {{ vhost.DocumentRoot }}

    DirectoryIndex index.html index.php
    ErrorLog {{ vhost.ErrorLog }}
    LogLevel warn
    CustomLog {{ vhost.AccessLog }} combined

    {% for alias in vhost.ServerAlias %}
    ServerAlias {{ alias }}
    {% endfor %}

    {% if vhost.SSLEnabled %}
    SSLEngine On
    SSLProtocol all -SSLv2
    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM
    SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown

    {% if vhost.Certificate.CertificateFilePath != "" %}
    SSLCertificateFile {{ vhost.Certificate.CertificateFilePath }}
    {% endif %}

    {% if vhost.Certificate.CertificateKeyFilePath != "" %}
    SSLCertificateKeyFile {{ vhost.Certificate.CertificateKeyFilePath }}
    {% endif %}

    {% if vhost.Certificate.CertificateChainFilePath != "" %}
    SSLCertificateChainFile {{ vhost.Certificate.CertificateChainFilePath }}
    {% endif %}

    {% if vhost.Certificate.CACertificateFilePath != "" %}
    SSLCACertificateFile {{ vhost.Certificate.CACertificateFilePath }}
    {% endif %}
    {% endif %}

    {% if vhost.ForceSSL %}
    ## Force SSL
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
    ## End Force SSL
    {% endif %}

    {% if vhost.PHPEnabled %}
        # PHP Support
        FastCGIExternalServer {{ vhost.DocumentRoot }}/php-fpm -socket {{vhost.PhpFpmSocket}} -pass-header Authorization
        AddType application/x-httpd-fastphp .php
        Action application/x-httpd-fastphp /php-fpm
        # End PHP Support
    {% endif %}

    <Directory "/">
        Options FollowSymLinks
        AllowOverride None
        Order allow,deny
        Deny from all
    </Directory>

    <Directory "{{ vhost.DocumentRoot }}">
        Options FollowSymLinks +ExecCGI
        AllowOverride FileInfo Indexes Limit AuthConfig
        Order Allow,Deny
        Allow From All

        {% if vhost.PathOptionForDocumentRoot is not null %}
        {{ macros.pathoption(vhost.PathOptionForDocumentRoot) }}
        {% endif %}

        {% if vhost.ProtectionForDocumentRoot is not null %}
        {{ macros.protection(vhost.ProtectionForDocumentRoot) }}
        {% endif %}
    </Directory>

    {% for coll in vhost.DirectoryOptions %}
    <Directory "{{ coll.path }}">
        {% if coll.pathoption is not null %}
        {{ macros.pathoption(coll.pathoption) }}
        {% endif %}

        {% if coll.protection is not null %}
        {{ macros.protection(coll.protection) }}
        {% endif %}
    </Directory>
    {% endfor %}

    {% if vhost.RedirectUrl != '' %}
        Redirect / {{ vhost.RedirectUrl }}
    {% endif %}

    ## Custom
    {{ vhost.CustomConfig }}
    ## End Custom
</VirtualHost>
{% endfor %}
