##
#
# Generated by
#
# LampCP
# https://github.com/jeboehm/LampCP
#
# Licensed under the GPL Version 2 license
# http://www.gnu.org/licenses/gpl-2.0.txt
#
# PLEASE DO NOT CHANGE MANUALLY
# CHANGES WILL BE OVERWRITTEN
#
##

{% import "JeboehmLampcpLightyConfigBundle:Lighttpd:vhost.macro.twig" as macros %}

server.bind = "127.0.0.1"
server.modules += ( "mod_fastcgi", "mod_accesslog", "mod_setenv", "mod_auth", "mod_rewrite" )

{% for ip in ips %}
    {% if ip.HasSsl and defaultcert %}
        {% if ip.isIpv6 %}
            $SERVER["socket"] == "[{{ ip.Ip }}]:{{ ip.Port }}" {
        {% else %}
            $SERVER["socket"] == "{{ ip.Ip }}:{{ ip.Port }}" {
        {% endif %}

            ssl.engine = "enable"
            ssl.pemfile = "{{ defaultcert.CertificateFilePath }}"
        }
    {% endif %}
{% endfor %}

{% for vhost in vhosts %}
    {% if not vhost.BoundToAllIps %}
    $SERVER["socket"] == "{{ vhost.VhostAddress }}" {
    {% endif %}
        $HTTP["host"] =~ "{{ vhost.ServerNameRegex }}" {
        {% if vhost.ForceSSL %}
            ## Force SSL
            url.redirect = ("^/(.*)" => "https://{{ vhost.ServerName }}/$1")
            ## End Force SSL
        {% else %}
            server.document-root = "{{ vhost.DocumentRoot }}"
            accesslog.filename = "{{ vhost.AccessLog }}"
            server.follow-symlink = "enable"
            server.dir-listing = "disable"

            {% if vhost.PHPEnabled %}
            fastcgi.server = (
                ".php" => (
                    (
                        "socket" => "{{ vhost.PhpFpmSocket }}",
                        "broken-scriptfilename" => "enable"
                    )
                )
            )
            {% endif %}

            {% if vhost.SSLEnabled %}
                setenv.add-environment = (
                    "HTTPS" => "on"
                )

                ssl.engine = "enable"

                {% if vhost.Certificate.CertificateFilePath != "" %}
                    ssl.pemfile = "{{ vhost.Certificate.CertificateFilePath }}"
                {% endif %}

                {% if vhost.Certificate.CertificateChainFilePath != "" %}
                    ssl.ca-file = "{{ vhost.Certificate.CertificateChainFilePath }}"
                {% elseif vhost.Certificate.CACertificateFilePath != "" %}
                    ssl.ca-file = "{{ vhost.Certificate.CACertificateFilePath }}"
                {% endif %}
            {% endif %}

            {% for coll in vhost.DirectoryOptions %}
                $HTTP["url"] =~ "^{{ coll.path }}" {
                    {% if coll.pathoption is not null %}
                        {{ macros.pathoption(coll.pathoption) }}
                    {% endif %}

                    {% if coll.protection is not null %}
                        {{ macros.protection(coll.protection) }}
                    {% endif %}
                }
            {% endfor %}

            {% if vhost.RedirectUrl != '' %}
                url.redirect = (
                    ".*" => "{{ vhost.RedirectUrl }}",
                )
            {% endif %}

            ## Custom
            {{ vhost.CustomConfig|raw }}
            ## End Custom
        {% endif %}
        }
    {% if not vhost.BoundToAllIps %}
    }
    {% endif %}
{% endfor %}
